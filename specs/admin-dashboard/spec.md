# 功能规格说明书：微信支付分账后台管理界面

**Feature**: `admin-dashboard`
**Scope**: `packages/wechat-pay-profit-share-bundle`
**创建日期**: 2025-11-28
**状态**: Draft
**输入**: 用户描述 "packages/wechat-pay-profit-share-bundle 需要后台管理界面"

## 用户场景与测试（必填）

### 用户故事 1 - 创建分账订单（优先级：P0）

作为运营人员，我需要在后台直接创建分账订单并发起分账请求，以便完成资金分配操作。

**优先级原因**：创建分账是核心业务操作，是完成整个分账流程的入口，直接影响业务运转。

**独立验证方式**：登录后台，进入创建分账订单页面，填写必要信息后提交，系统调用微信 API 完成分账。

**验收场景**：

1. **Given** 运营人员已登录后台，**When** 点击"创建分账订单"，**Then** 显示创建表单，包含：商户选择、特约商户号、微信支付订单号、商户分账单号、是否解冻剩余资金
2. **Given** 创建表单已打开，**When** 点击"添加接收方"，**Then** 可手动输入接收方信息（类型、账号、姓名、金额、描述）
3. **Given** 已填写完整的分账信息（至少一个接收方，金额 > 0），**When** 点击提交，**Then** 系统调用微信 API 发起分账请求，成功后显示分账订单详情
4. **Given** 提交分账请求，**When** 微信 API 返回错误，**Then** 显示错误信息，不保存任何记录，用户需重新填写

---

### 用户故事 2 - 分账订单查看与管理（优先级：P1）

作为运营人员，我需要在后台查看和管理分账订单，以便追踪分账执行状态、排查问题并确保资金分配正确。

**优先级原因**：分账订单是核心业务数据，运营人员最频繁查询的信息，直接影响日常运营效率。

**独立验证方式**：登录后台，进入分账订单列表页，可查看订单列表并筛选、搜索特定订单，查看订单详情及关联的接收方信息。

**验收场景**：

1. **Given** 运营人员已登录后台，**When** 进入分账订单列表页，**Then** 显示分账订单列表，包含商户分账单号、微信分账单号、特约商户号、分账状态、创建时间等核心字段
2. **Given** 分账订单列表已加载，**When** 输入商户分账单号或微信支付订单号进行搜索，**Then** 列表精确过滤显示匹配的订单
3. **Given** 分账订单列表已加载，**When** 按分账状态（处理中/已完成/已关闭）筛选，**Then** 列表仅显示对应状态的订单
4. **Given** 分账订单列表中存在订单，**When** 点击某条订单查看详情，**Then** 展示订单完整信息及其关联的所有分账接收方明细（类型、账号、金额、结果、失败原因等）

---

### 用户故事 3 - 分账接收方明细查看（优先级：P1）

作为运营人员，我需要查看分账接收方的详细信息和分账结果，以便了解每笔分账的资金流向和处理状态。

**优先级原因**：接收方明细是分账核心数据的组成部分，必须与订单管理一同提供才能形成完整的业务闭环。

**独立验证方式**：在分账订单详情页或独立的接收方列表页查看接收方信息，包括分账金额、结果状态、失败原因等。

**验收场景**：

1. **Given** 运营人员查看某笔分账订单详情，**When** 页面加载完成，**Then** 显示该订单下所有接收方列表，包含类型、账号、金额、描述、分账结果、失败原因
2. **Given** 某接收方分账失败，**When** 查看该接收方记录，**Then** 清晰显示失败原因和重试次数
3. **Given** 分账接收方列表已加载，**When** 按分账结果（待处理/成功/失败）筛选，**Then** 列表仅显示对应状态的接收方

---

### 用户故事 4 - 解冻剩余资金（优先级：P1）

作为运营人员，我需要对已完成分账的订单解冻剩余未分资金，以便将资金释放回特约商户。

**优先级原因**：解冻操作是分账流程的必要收尾步骤，直接影响商户资金可用性。

**独立验证方式**：在分账订单详情页点击"解冻剩余资金"按钮，完成解冻操作。

**验收场景**：

1. **Given** 运营人员查看某笔已完成分账的订单详情，**When** 点击"解冻剩余资金"，**Then** 显示确认对话框，包含订单信息和解冻描述输入框
2. **Given** 确认解冻信息，**When** 点击确认，**Then** 系统调用微信 API 解冻资金，成功后更新订单状态
3. **Given** 解冻请求，**When** 微信 API 返回错误，**Then** 显示错误信息，订单状态不变

---

### 用户故事 5 - 发起分账回退（优先级：P1）

作为运营人员，我需要对已分账的资金发起回退请求，以便处理退款等场景。

**优先级原因**：回退是分账流程的重要组成部分，退款场景下必须支持。

**独立验证方式**：在分账订单详情页点击"发起回退"，填写回退信息后提交。

**验收场景**：

1. **Given** 运营人员查看某笔已完成分账的订单详情，**When** 点击"发起回退"，**Then** 显示回退表单，包含：商户回退单号、回退金额、回退描述
2. **Given** 已填写完整的回退信息（金额 > 0），**When** 点击提交，**Then** 系统调用微信 API 发起回退请求，成功后显示回退单详情
3. **Given** 提交回退请求，**When** 微信 API 返回错误，**Then** 显示错误信息，不保存任何记录

---

### 用户故事 6 - 分账回退单查看（优先级：P2）

作为运营人员，我需要查看和管理分账回退单，以便追踪回退状态和结果。

**优先级原因**：回退场景虽不如正向分账频繁，但在退款流程中至关重要，影响客户体验和财务对账。

**独立验证方式**：进入分账回退单列表页，查看回退单列表及详情，了解回退状态和结果。

**验收场景**：

1. **Given** 运营人员已登录后台，**When** 进入分账回退单列表页，**Then** 显示回退单列表，包含商户回退单号、微信回退单号、回退金额、回退结果、创建时间
2. **Given** 回退单列表已加载，**When** 按回退结果筛选，**Then** 列表仅显示对应状态的回退单
3. **Given** 某回退单处理失败，**When** 查看该回退单详情，**Then** 显示失败原因及关联的原分账单信息

---

### 用户故事 7 - 申请分账账单（优先级：P2）

作为运营人员，我需要申请下载分账账单，以便进行财务对账。

**优先级原因**：账单是财务对账的重要依据，需要提供申请入口。

**独立验证方式**：进入账单任务列表页，点击"申请账单"，填写日期后提交。

**验收场景**：

1. **Given** 运营人员已登录后台，**When** 点击"申请账单"，**Then** 显示申请表单，包含：账单日期选择
2. **Given** 已选择账单日期，**When** 点击提交，**Then** 系统调用微信 API 申请账单，成功后在列表中显示新任务
3. **Given** 提交账单申请，**When** 微信 API 返回错误，**Then** 显示错误信息

---

### 用户故事 8 - 分账账单任务查看（优先级：P2）

作为运营人员，我需要查看分账账单下载任务的状态，以便了解账单获取进度和下载结果。

**优先级原因**：账单是财务对账的重要依据，需要提供可视化管理便于运营追踪。

**独立验证方式**：进入账单任务列表页，查看任务状态和下载进度。

**验收场景**：

1. **Given** 运营人员已登录后台，**When** 进入分账账单任务列表页，**Then** 显示任务列表，包含账单日期、状态、下载地址、下载时间
2. **Given** 账单任务列表已加载，**When** 按状态（待处理/就绪/下载中/已下载/失败/过期）筛选，**Then** 列表仅显示对应状态的任务

---

### 用户故事 9 - 操作日志查询（优先级：P3）

作为运营人员或技术支持，我需要查看分账相关的操作日志，以便排查问题和审计操作记录。

**优先级原因**：操作日志是问题排查和合规审计的基础，虽非日常高频使用，但在特定场景下不可或缺。

**独立验证方式**：进入操作日志列表页，按条件筛选查看历史操作记录。

**验收场景**：

1. **Given** 运营人员已登录后台，**When** 进入操作日志列表页，**Then** 显示日志列表，包含操作类型、是否成功、错误码、错误信息、创建时间
2. **Given** 操作日志列表已加载，**When** 按操作类型或成功/失败状态筛选，**Then** 列表仅显示匹配的日志
3. **Given** 某条日志记录存在，**When** 查看日志详情，**Then** 可展示完整的请求负载和响应负载（供技术排查）

---

### 边界/异常场景

- 当列表数据量较大时，系统如何处理分页？（假设：采用标准分页机制，默认每页 20 条，支持自定义每页数量）
- 当搜索或筛选无结果时如何处理？（假设：显示"无匹配数据"提示）
- 敏感信息（如接收方姓名密文、请求/响应负载中的敏感字段）如何展示？（假设：敏感信息默认脱敏显示，仅授权用户可查看完整内容）
- 高并发访问时列表加载性能如何保证？（假设：采用数据库索引优化和缓存策略）

## 需求（必填）

### 功能需求

**分账订单创建（写操作）**
- **FR-001**：系统必须提供创建分账订单表单，包含：商户选择、特约商户号、微信支付订单号、商户分账单号、是否解冻剩余资金
- **FR-002**：系统必须支持在创建表单中手动添加多个接收方，每个接收方包含：类型、账号、姓名、金额（分）、描述
- **FR-003**：系统必须对分账信息进行基础校验：金额 > 0、接收方列表非空
- **FR-004**：系统必须调用微信支付 API 发起分账请求，成功后保存订单并跳转详情页
- **FR-005**：当微信 API 返回错误时，系统必须显示错误信息，不保存任何记录

**分账订单查看**
- **FR-006**：系统必须提供分账订单列表页，展示以下字段：ID、商户分账单号、微信分账单号、特约商户号、微信支付订单号、分账状态、是否解冻剩余资金、创建时间、更新时间
- **FR-007**：系统必须支持按商户分账单号、微信分账单号、微信支付订单号、特约商户号进行搜索
- **FR-008**：系统必须支持按分账状态进行筛选
- **FR-009**：系统必须提供分账订单详情页，展示订单完整信息及关联的接收方列表

**解冻剩余资金（写操作）**
- **FR-010**：系统必须在订单详情页提供"解冻剩余资金"操作按钮
- **FR-011**：系统必须显示解冻确认对话框，包含解冻描述输入框
- **FR-012**：系统必须调用微信支付 API 解冻资金，成功后更新订单状态

**分账接收方查看**
- **FR-013**：系统必须在订单详情中展示接收方列表，包含：类型、账号、姓名（脱敏）、金额、描述、分账结果、失败原因、重试次数、微信分账明细单号
- **FR-014**：系统必须支持按分账结果筛选接收方记录

**分账回退（写操作）**
- **FR-015**：系统必须在订单详情页提供"发起回退"操作按钮
- **FR-016**：系统必须提供回退表单，包含：商户回退单号、回退金额、回退描述
- **FR-017**：系统必须对回退信息进行基础校验：金额 > 0
- **FR-018**：系统必须调用微信支付 API 发起回退请求，成功后保存回退单并跳转详情页
- **FR-019**：当微信 API 返回错误时，系统必须显示错误信息，不保存任何记录

**分账回退单查看**
- **FR-020**：系统必须提供分账回退单列表页，展示：商户回退单号、微信回退单号、关联分账单号、回退金额、回退描述、回退结果、失败原因、创建时间
- **FR-021**：系统必须支持按回退结果、特约商户号进行筛选和搜索

**账单申请（写操作）**
- **FR-022**：系统必须提供"申请账单"操作入口
- **FR-023**：系统必须提供账单申请表单，包含：账单日期选择
- **FR-024**：系统必须调用微信支付 API 申请账单，成功后创建账单任务记录

**账单任务查看**
- **FR-025**：系统必须提供账单任务列表页，展示：账单日期、特约商户号、状态、下载地址、下载时间、本地存储路径
- **FR-026**：系统必须支持按状态、账单日期范围进行筛选

**操作日志管理**
- **FR-027**：系统必须提供操作日志列表页，展示：操作类型、特约商户号、是否成功、错误码、错误信息、创建时间
- **FR-028**：系统必须支持按操作类型、成功/失败状态进行筛选
- **FR-029**：系统必须提供日志详情页，可查看完整的请求负载和响应负载

**通用需求**
- **FR-030**：所有列表页必须支持分页功能
- **FR-031**：所有列表页必须支持按创建时间排序（默认倒序）
- **FR-032**：系统必须对敏感信息（姓名、负载中的敏感字段）进行脱敏处理
- **FR-033**：所有写操作使用统一权限控制，有后台访问权限即可执行

### 核心实体（若涉及数据）

- **ProfitShareOrder（分账订单）**：存储分账请求与响应状态，关联商户和特约商户号，包含微信支付订单号、分账状态、时间戳等
- **ProfitShareReceiver（分账接收方）**：存储每笔分账的接收方信息，包含类型、账号、金额、分账结果、失败原因等，与 ProfitShareOrder 为多对一关系
- **ProfitShareReturnOrder（分账回退单）**：存储分账回退请求与结果，关联原分账单
- **ProfitShareBillTask（账单任务）**：存储账单下载任务状态和进度
- **ProfitShareOperationLog（操作日志）**：记录所有分账相关 API 操作，便于审计和问题排查

## 成功标准（必填）

### 可度量结果

- **SC-001**：运营人员可在 3 秒内加载并查看分账订单列表（1000 条以内数据量）
- **SC-002**：通过搜索或筛选定位到目标订单/记录的操作不超过 3 次点击
- **SC-003**：所有 CRUD 列表页支持至少 10,000 条记录的正常分页浏览
- **SC-004**：运营人员可通过后台界面完成分账订单查询、创建、解冻、回退等全流程操作，无需数据库直查或命令行介入
- **SC-005**：95% 的列表加载和搜索操作在 2 秒内完成响应

## 澄清记录

### Session 2025-11-28

- Q: 分账订单创建范围？ → A: 完整流程 + 回退 + 账单申请（创建订单 + 添加接收方 + 解冻剩余资金 + 发起分账回退 + 申请下载账单）
- Q: 微信 API 调用失败处理策略？ → A: 直接报错，不保存任何记录，用户需重新填写
- Q: 分账接收方配置方式？ → A: 仅手动输入（每次填写接收方类型、账号、金额等）
- Q: 操作权限控制粒度？ → A: 统一权限（有后台访问权限即可执行所有操作）
- Q: 分账金额校验规则？ → A: 仅基础校验（金额 > 0，接收方列表非空）

## 假设与约束

### 假设
- 后台管理框架已集成 EasyAdmin，将基于现有框架扩展
- 用户权限体系已存在，本功能复用现有权限控制机制
- 数据库表已存在且数据结构稳定，无需额外迁移
- 分页默认每页 20 条，最大支持每页 100 条

### 约束
- 后台管理界面仅供内部运营使用，不对外开放
- 敏感数据展示需遵守公司数据安全规范
- 支持完整分账操作流程：创建订单、添加接收方、解冻剩余资金、发起回退、申请账单
