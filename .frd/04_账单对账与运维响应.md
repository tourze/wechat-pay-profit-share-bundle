# FRD 04：账单对账与运维响应

> 阶段目标：在 Stage 2（FRD 03）稳定运行后，确保所有分账通知、账单、对账差异与运维响应闭环，支撑财务与合规审计。

## 📊 快速概览
| 项目 | 信息 |
| --- | --- |
| **ID** | `wechat-pay-profit-share-bundle:04-reconcile@v1.0` |
| **阶段** | `🔵需求` → `🟢设计` → `⚪任务` → `⚪实施` → `⚪验证` |
| **覆盖范围** | 回调验签、账单下载、对账差异、监控告警、Runbook |
| **依赖** | `FRD 03` 分账执行数据、日志系统、Prometheus、存储空间 |

---

## 1️⃣ 回调处理链路
- **回调入口**：`POST /wechat/pay/profit-sharing/notify`（待配置），沿用支付回调域名。
- **处理步骤**：
  1. 验签：使用 `WechatPayBundle` 的 `NotificationVerifier`，核对 `Wechatpay-Signature`。
  2. 解密：解析 `resource` 字段，解密得到分账结果。
  3. 幂等：根据 `event_id + event_type` 校验是否重复处理。
  4. 状态更新：更新 `ProfitShareOrder`、`ProfitShareOrderItem`、`ProfitShareReturnOrder`。
  5. 事件派发：触发 `ProfitShareNotificationHandledEvent`。
- **回调分类**：
  - `PROFITSHARING.TRANSFER.SUCCESS/FAIL`：分账执行结果。
  - `PROFITSHARING.RETURN.SUCCESS/FAIL`：回退结果。
- **异常处理**：验签失败返回 401 并记录安全告警；解密失败返回 500 并保留原文供人工排查。

---

## 2️⃣ 账单获取与对账流程
```mermaid
flowchart TD
  A([每日 09:00 定时任务]) --> B[下载 profitsharingbill]
  B --> C[下载 fundflowbill (可选)]
  C --> D[解压 & 解析 CSV]
  D --> E[写入 ProfitShareBill / ProfitShareBillItem]
  E --> F[聚合本地分账数据]
  F --> G[对比并生成差异 ProfitShareReconciliation]
  G --> H{差异>0?}
  H -->|是| I[创建差异工单<br/>推送至财务系统/飞书]
  H -->|否| J[记录成功指标]
  I --> K([End])
  J --> K
```

- **接口**：`GET /v3/bill/profitsharingbill`, `GET /v3/bill/fundflowbill`。
- **存储**：账单原始文件保存在 `var/wechat-pay/bills/profit-sharing/{date}`，每日归档。
- **差异分类**：
  - `MISSING_LOCAL`：微信有记录，本地无。
  - `MISSING_WECHAT`：本地有记录，微信无。
  - `AMOUNT_MISMATCH`：金额不一致。
  - `STATE_MISMATCH`：状态不同。

---

## 3️⃣ 数据模型与存储策略
- **实体**：
  - `ProfitShareNotification`：回调原文、事件类型、处理状态、关联订单。
  - `ProfitShareBill`：账单元信息（日期、类型、文件路径、解析状态）。
  - `ProfitShareBillItem`：账单明细（订单号、接收方、金额、状态）。
  - `ProfitShareReconciliation`：差异记录（类型、金额、责任人、解决状态）。
- **索引**：
  - `bill_date + order_no`，快速定位差异。
  - `event_id` 唯一索引，保障回调幂等。
- **存储要求**：
  - 账单文件保留 18 个月；可选上传到 OSS/对象存储。
  - 回调原文加密存储，防止敏感信息泄露。

---

## 4️⃣ 观测指标与告警策略
- **Prometheus 指标**：
  - `profit_share_callback_total{status}`：回调处理情况。
  - `profit_share_bill_download_total{result}`：账单下载成功/失败次数。
  - `profit_share_reconcile_diff_total{diff_type}`：差异数量。
  - `profit_share_reconcile_duration_seconds`：对账耗时。
- **日志规范**：
  - 回调日志字段：`event_id`、`event_type`、`order_no`、`result_code`。
  - 对账日志字段：`bill_date`、`diff_type`、`amount`、`handler`。
- **告警触发**：
  - 账单下载连续失败2次 → 告警。
  - 差异数量>0 → 自动创建飞书工单并标记负责人。
  - 回调验签失败 → 高优先级安全告警，触发应急响应。
- **Runbook 要点**：
  - 差异处理步骤（核对原订单 → 联系商户/接收方 → 决策回退/补差）。
  - 通知链路（运维 → 财务 → 安全）。

---

## 5️⃣ 质量门与测试矩阵
- **静态分析**：`phpstan`。
- **单元测试**：
  - 回调验签逻辑（签名正确/错误）。
  - CSV 解析异常处理（字段缺失、格式错误）。
  - 差异分类算法（金额四舍五入、币种校验）。
- **集成测试**：
  - 使用 MockServer 模拟账单下载，验证重试与容错。
  - 回调接口端到端测试（含幂等）。
- **性能测试**：
  - 账单解析 1 万条记录，目标耗时 < 5 分钟。
  - 对账差异计算 CPU/内存评估，确保生产可用。

---

## 6️⃣ 风险处置与回滚
| 风险 | 场景 | 缓解 | 回滚 |
| --- | --- | --- | --- |
| 回调被伪造 | 验签失败或IP异常 | IP 白名单、失败告警 | 暂停回调入口，人工核验 |
| 账单格式变化 | CSV字段调整 | 解析器版本化+容错 | 回退解析器版本，联系微信侧 |
| 大量差异 | 本地数据错/微信系统问题 | 差异分级，快速标记责任人 | 停止自动记账，改为人工流程 |
| 存储空间不足 | 账单长期积累 | 定期归档至OSS，设置生命周期 | 清理旧文件，保持本地7天 |

回滚策略：关闭账单下载/对账定时任务，保留器件数据；回调入口可临时返回 503，防止误处理，同时保留原文供后续补处理。

---

## 7️⃣ 未决事项
1. 财务需要的差异工单格式（Excel、工单系统API）待确认。
2. 回调通知是否需要推送至安全中心？影响告警集成。
3. 是否保留历史账单的PDF/可视化报表？涉及额外存储与渲染。
4. 账单差异处理SLA由谁负责？需在Runbook中明确责任人。

> 完成后标志 Stage 3 质量门可关闭，具备上线条件。
