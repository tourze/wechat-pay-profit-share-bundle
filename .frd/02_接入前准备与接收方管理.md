# FRD 02：接入前准备与接收方管理

> 阶段目标：在未触发分账之前，完成接收方与商户的合规备案、资料校验与审批链路，保障 Stage 2 顺利执行。

## 📊 快速概览
| 项目 | 信息 |
| --- | --- |
| **ID** | `wechat-pay-profit-share-bundle:02-receivers@v1.0` |
| **阶段** | `🔵需求` → `🟢设计` → `⚪任务` → `⚪实施` → `⚪验证` |
| **覆盖范围** | 接收方资料、审批、微信备案、命令工具、Admin界面 |
| **依赖** | `WechatPayBundle` 中的 `Merchant`、`WechatPayBuilder`、`自动化证书管理` |

---

## 1️⃣ 前置依赖与能力校验
- **商户与证书**：
  - 必须存在有效的 `Merchant` 配置（`mch_id`、`api_key`、`cert_serial`、`pem_key`、`pem_cert`）。
  - 新增命令 `wechat:profit-share:check-merchant`，校验证书有效期、序列号、API权限。
- **组织流程**：
  - 产品提供接收方资料模板（字段、格式、附件要求）。
  - 财务/合规定义审批步骤、操作权限矩阵。
- **系统依赖**：
  - `tourze/encryptable-bundle`（或等价组件）确保敏感字段加密。
  - `messenger` 消息队列，用于接收方同步失败后的重试。
  - 日志/监控平台可用（用于审计与告警）。

---

## 2️⃣ 接收方生命周期流程
```mermaid
flowchart TD
  A([Start]) --> B[业务提交<br/>接收方资料]
  B --> C[系统校验基础字段<br/>(证件、账号、比例上限)]
  C --> D{本地审批通过?}
  D -->|否| E[状态=REJECTED<br/>返回业务补充]
  D -->|是| F[状态=LOCAL_APPROVED<br/>准备调用微信]
  F --> G[调用 /v3/profitsharing/receivers/add]
  G --> H{微信响应}
  H -->|失败| I[状态=FAILED<br/>记录错误+重试队列]
  H -->|成功| J[状态=WX_PENDING<br/>等待回调或轮询]
  J --> K{微信最终状态}
  K -->|拒绝| L[状态=WX_REJECTED<br/>通知审批人]
  K -->|通过| M[状态=AVAILABLE<br/>可参与分账]
  K -->|需审核| N[状态=WX_PROCESSING<br/>继续轮询]
  M --> O([End])
  E --> O
  L --> O
  N --> K
```

- **状态机**：`DRAFT → LOCAL_APPROVED → WX_PENDING → AVAILABLE/FAILED/WX_REJECTED`。
- **冻结/解冻**：Admin 可对 `AVAILABLE` 接收方执行冻结，进入 `FROZEN`，禁止分账；解冻后返回原状态。
- **删除流程**：调用 `/v3/profitsharing/receivers/delete`，状态→`REMOVED`；删除后如需再次启用必须重新备案。

---

## 3️⃣ 数据模型与安全要求
- **实体**：
  - `ProfitShareReceiver`：核心信息（账号、类型、姓名/名称、证件、分账比例上限、状态、幂等键）。
  - `ReceiverCredential`（值对象）：证件类型、号码、有效期；字段级AES加密。
  - `ReceiverAuditLog`：记录每次审批、微信响应、操作者。
  - `ReceiverSyncTask`：保存与微信同步的任务状态与重试计数。
- **索引策略**：
  - 唯一索引：`partner_mch_id + sub_mch_id + account + account_type`。
  - 状态索引：`status` 用于任务扫描。
- **数据安全**：
  - 敏感字段加密后存储；日志只记录脱敏信息（例如只展示手机号后4位）。
  - Admin界面按角色划分字段可见性（财务可见全量，运营仅可见基础信息）。
  - 审计日志需记录IP、操作来源、操作人。

---

## 4️⃣ 服务接口与系统交互
- **应用服务**：
  - `ReceiverRegistry::register(RegisterReceiverCommand)`：入口，完成校验、落库、发起微信调用。
  - `ReceiverRegistry::remove(RemoveReceiverCommand)`：触发删除。
  - `ReceiverRegistry::freeze/activate`：冻结/解冻操作。
- **查询接口**：
  - `ReceiverQuery::findAvailableByMerchant(string $mchId, ?string $subMchId)`。
  - `ReceiverQuery::findByIdWithAudit(string $receiverId)`。
- **命令/任务**：
  - `wechat:profit-share:sync-receivers --limit=100`：轮询 `WX_PENDING` 状态。
  - 失败重试：使用 Messenger 延迟队列，最多3次，每次退避扩展。
- **Admin/UI**：
  - 列表：状态、账号、比例、最后同步时间。
  - 表单校验：实时校验字段格式（例如身份证、统一社会信用代码）。

---

## 5️⃣ 质量门与测试策略
- **静态分析**：`phpstan analyse packages/wechat-pay-profit-share-bundle/src --level=max`。
- **单元测试**：
  - 命令对象校验（缺字段/非法比例）。
  - 幂等逻辑（重复注册、重复删除）。
  - 状态机转换（冻结、解冻、删除）。
- **集成测试**：
  - Mock 微信API：成功、失败、系统繁忙（HTTP 5xx）、幂等冲突。
  - Admin 提交流程（Behat/Cypress）。
- **安全测试**：
  - 确认数据库敏感字段已加密（通过迁移或直接查询验证）。
  - 日志中不得出现明文证件号。

---

## 6️⃣ 风险与例外卡
- **资料不完整**：建立校验规则并提供错误提示；审批流程可退回。
- **并发新增**：数据库唯一索引 + 幂等键，若触发异常需捕获并返回友好提示。
- **微信权限不足**：命令 `check-merchant` 每日巡检，结果写入监控。
- **例外卡范例**：
  ```yaml
  owner: finance.lead
  scope: packages/wechat-pay-profit-share-bundle/src/Entity/ProfitShareReceiver.php
  reason: >
    财务审批系统尚未接入，临时允许手工审批并跳过本地流程。
  constraints:
    type: [TOLERATE: PROCESS]
    expires_at: 2025-03-31
    cleanup_plan: |
      - 接入第三方审批系统
      - 完成审批记录与API联通
  notes: 审批日志需人工上传至共享盘
  ```

---

## 7️⃣ 未决事项
1. 审批流程是否需要支持多级会签？影响实体设计与UI交互。
2. 是否支持批量导入接收方资料？若支持需定制模板校验。
3. 微信回调地址是否沿用支付回调域名还是独立域名？涉及安全策略。
4. 接收方比例上限由业务提供还是系统自动计算？需确认权责。

> 完成以上事项后方可进入 FRD 03 的开发阶段。
