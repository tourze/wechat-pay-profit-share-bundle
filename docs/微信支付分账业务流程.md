# 微信支付分账业务流程图

## 概述

微信支付分账（Profit Sharing）是微信支付为商户提供的资金分配服务，允许商户将收款后的资金分配给多个接收方。本文档基于 `wechat-pay-profit-share-bundle` 实现，梳理完整的业务流程。

## 核心业务模块

### 1. 分账接收方管理 (ProfitShareReceiverService)
- **添加接收方** (`addReceiver`): 将分账接收方添加到微信支付系统
- **删除接收方** (`deleteReceiver`): 从微信支付系统移除分账接收方

### 2. 分账订单管理 (ProfitShareService)  
- **请求分账** (`requestProfitShare`): 发起分账请求
- **查询分账结果** (`queryProfitShareOrder`): 查询分账订单状态
- **解冻剩余资金** (`unfreezeRemainingAmount`): 解冻未分账的资金

### 3. 分账回退管理 (ProfitShareReturnService)
- **请求回退** (`requestReturn`): 将已分账资金回退
- **查询回退结果** (`queryReturn`): 查询回退订单状态

### 4. 分账账单管理 (ProfitShareBillService)
- **申请账单** (`applyBill`): 申请分账账单下载
- **下载账单** (`downloadBill`): 下载分账账单文件

### 5. 分账配置查询 (ProfitShareConfigurationService)
- **查询剩余金额** (`queryRemainingAmount`): 查询可分账剩余金额
- **查询最大分账比例** (`queryMaxRatio`): 查询分账比例限制

### 6. 通知处理 (ProfitShareNotificationService)
- **处理分账通知** (`handleNotification`): 处理微信支付的分账结果通知

## 业务流程图

### 整体业务流程概览

```mermaid
flowchart TD
    A([开始]) --> B[用户支付完成]
    B --> C{是否需要分账?}
    C -->|否| D[结束]
    C -->|是| E[配置分账接收方]
    
    E --> F[添加接收方到微信]
    F --> G{添加成功?}
    G -->|否| H[处理添加失败]
    G -->|是| I[发起分账请求]
    
    I --> J[微信处理分账]
    J --> K[接收分账结果通知]
    K --> L[查询分账状态确认]
    
    L --> M{分账成功?}
    M -->|处理中| N[等待通知/轮询查询]
    N --> L
    M -->|失败| O[处理分账失败]
    M -->|成功| P[分账完成]
    
    O --> Q{需要回退?}
    P --> R{需要解冻资金?}
    Q -->|是| S[发起分账回退]
    Q -->|否| T[结束]
    R -->|是| U[解冻剩余资金]
    R -->|否| T
    
    S --> V[回退处理完成]
    U --> W[解冻完成]
    V --> T
    W --> T
    
    H --> X[重试或人工处理]
    X --> E
```

### 分账接收方管理流程

```mermaid
flowchart TD
    A([添加接收方]) --> B[构建接收方请求]
    B --> C[敏感信息加密]
    C --> D[调用微信添加接口]
    D --> E{添加成功?}
    E -->|是| F[记录操作日志]
    E -->|否| G[记录错误日志]
    F --> H[返回成功结果]
    G --> I[抛出异常]
    
    J([删除接收方]) --> K[构建删除请求]
    K --> L[调用微信删除接口]
    L --> M{删除成功?}
    M -->|是| N[记录操作日志]
    M -->|否| O[记录错误日志]
    N --> P[返回成功结果]
    O --> Q[抛出异常]
```

### 分账订单处理流程

```mermaid
flowchart TD
    A([发起分账]) --> B[验证分账接收方]
    B --> C[构建分账订单实体]
    C --> D[生成分账请求数据]
    D --> E[调用微信分账接口]
    E --> F{请求成功?}
    F -->|否| G[记录失败日志]
    F -->|是| H[解析响应数据]
    H --> I[更新订单状态]
    I --> J[同步接收方状态]
    J --> K[记录操作日志]
    K --> L[返回订单实体]
    
    M([查询分账结果]) --> N[获取本地订单]
    N --> O{订单存在?}
    O -->|否| P[创建新订单实体]
    O -->|是| Q[使用现有订单]
    P --> R[调用微信查询接口]
    Q --> R
    R --> S{查询成功?}
    S -->|否| T[记录查询失败]
    S -->|是| U[更新订单状态]
    U --> V[同步接收方结果]
    V --> W[更新时间信息]
    W --> X[保存订单数据]
    X --> Y[返回订单信息]
    
    G --> Z[抛出异常]
    T --> Z
```

### 分账回退流程

```mermaid
flowchart TD
    A([发起分账回退]) --> B[检查回退订单是否存在]
    B --> C{订单已存在?}
    C -->|是| D[返回现有订单]
    C -->|否| E[创建回退订单实体]
    E --> F[构建回退请求数据]
    F --> G[调用微信回退接口]
    G --> H{回退成功?}
    H -->|否| I[记录失败日志]
    H -->|是| J[解析回退响应]
    J --> K[更新回退订单状态]
    K --> L[记录操作日志]
    L --> M[保存订单数据]
    M --> N[返回回退订单]
    
    O([查询回退结果]) --> P[验证查询参数]
    P --> Q[获取或创建查询实体]
    Q --> R[调用微信查询接口]
    R --> S{查询成功?}
    S -->|否| T[记录查询失败]
    S -->|是| U[更新回退状态]
    U --> V[更新时间信息]
    V --> W[保存查询结果]
    W --> X[返回回退信息]
    
    I --> Y[抛出异常]
    T --> Y
```

### 分账账单处理流程

```mermaid
flowchart TD
    A([申请分账账单]) --> B[构建账单查询参数]
    B --> C[检查是否已申请过]
    C --> D{任务已存在?}
    D -->|是| E[使用现有任务]
    D -->|否| F[创建账单任务]
    E --> G[调用微信账单接口]
    F --> G
    G --> H{申请成功?}
    H -->|否| I[记录申请失败]
    H -->|是| J[解析账单下载信息]
    J --> K[更新任务状态为待下载]
    K --> L[保存下载URL和校验信息]
    L --> M[返回账单任务]
    
    N([下载分账账单]) --> O[获取下载地址]
    O --> P{有有效下载地址?}
    P -->|否| Q[抛出异常]
    P -->|是| R[调用下载接口]
    R --> S{下载成功?}
    S -->|否| T[记录下载失败]
    S -->|是| U[处理压缩文件]
    U --> V[保存到本地文件]
    V --> W[校验文件哈希值]
    W --> X{校验通过?}
    X -->|否| Y[删除文件并报错]
    X -->|是| Z[更新任务状态为已下载]
    Z --> AA[记录本地文件路径]
    AA --> BB[返回任务信息]
    
    I --> CC[抛出异常]
    T --> CC
    Q --> CC
    Y --> CC
```

### 通知处理流程

```mermaid
flowchart TD
    A([接收分账通知]) --> B[验证通知签名]
    B --> C{签名验证通过?}
    C -->|否| D[记录验证失败日志]
    C -->|是| E[解析通知内容]
    E --> F[获取分账订单信息]
    F --> G{订单存在?}
    G -->|否| H[创建新订单记录]
    G -->|是| I[更新现有订单]
    H --> J[保存通知数据]
    I --> J
    J --> K[处理分账结果]
    K --> L[更新接收方状态]
    L --> M[触发业务后续处理]
    M --> N[返回处理成功]
    
    D --> O[返回处理失败]
```

## 状态流转

### 分账订单状态

```mermaid
stateDiagram-v2
    [*] --> PROCESSING: 发起分账
    PROCESSING --> SUCCESS: 分账成功
    PROCESSING --> FAILED: 分账失败
    PROCESSING --> PROCESSING: 处理中
    
    SUCCESS --> [*]
    FAILED --> [*]
    
    note right of SUCCESS
        所有接收方分账成功
        可以进行后续操作
    end note
    
    note right of FAILED
        部分或全部接收方失败
        可能需要重试或回退
    end note
```

### 接收方结果状态

```mermaid
stateDiagram-v2
    [*] --> PENDING: 等待处理
    PENDING --> SUCCESS: 分账成功
    PENDING --> FAILED: 分账失败
    PENDING --> PROCESSING: 处理中
    
    SUCCESS --> [*]
    FAILED --> [*]
    PROCESSING --> PENDING: 继续等待
    
    note right of SUCCESS
        接收方已收到分账资金
    end note
    
    note right of FAILED
        接收方分账失败
        查看失败原因
    end note
```

## 关键技术点

### 1. 安全机制
- **敏感信息加密**: 接收方姓名使用RSA加密
- **签名验证**: 通知回调需要验证微信支付签名
- **数据校验**: 账单文件下载后进行哈希校验

### 2. 幂等性处理
- 所有操作基于业务单号(`out_order_no`, `out_return_no`)进行幂等控制
- 重复请求返回已存在的订单实体

### 3. 异步处理
- 分账请求异步处理，需要通过通知或主动查询获取结果
- 支持轮询查询机制确认最终状态

### 4. 错误处理
- 完整的操作日志记录
- 详细的错误信息和错误码记录
- 支持重试机制

## API接口映射

| 功能模块 | 微信支付API | 本服务方法 |
|---------|------------|-----------|
| 添加分账接收方 | POST /v3/profitsharing/receivers/add | `addReceiver()` |
| 删除分账接收方 | POST /v3/profitsharing/receivers/delete | `deleteReceiver()` |
| 请求分账 | POST /v3/profitsharing/orders | `requestProfitShare()` |
| 查询分账结果 | GET /v3/profitsharing/orders/{out_order_no} | `queryProfitShareOrder()` |
| 请求分账回退 | POST /v3/profitsharing/return-orders | `requestReturn()` |
| 查询分账回退 | GET /v3/profitsharing/return-orders/{out_return_no} | `queryReturn()` |
| 解冻剩余资金 | POST /v3/profitsharing/orders/unfreeze | `unfreezeRemainingAmount()` |
| 申请分账账单 | GET /v3/profitsharing/bills | `applyBill()` |
| 查询分账配置 | GET /v3/profitsharing/merchant-configs/{sub_mchid} | `queryConfiguration()` |

## 监控与日志

### 关键监控指标
- 分账请求成功率
- 分账处理延迟时间  
- 接收方添加/删除成功率
- 账单下载成功率
- 通知处理成功率

### 日志记录要点
- 每个API调用的请求和响应数据
- 操作耗时统计
- 错误码和错误信息
- 业务状态变更记录

## 使用示例

### 基本分账流程

```php
// 1. 添加分账接收方
$receiverService->addReceiver($merchant, $addRequest);

// 2. 发起分账
$order = $profitService->requestProfitShare($merchant, $orderRequest);

// 3. 查询分账结果
$result = $profitService->queryProfitShareOrder(
    $merchant, 
    $subMchId, 
    $outOrderNo, 
    $transactionId
);

// 4. 如需解冻剩余资金
$profitService->unfreezeRemainingAmount($merchant, $unfreezeRequest);
```

此文档完整梳理了微信支付分账业务的流程，可作为开发和运维参考文档使用。